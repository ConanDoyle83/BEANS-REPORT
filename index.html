<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>è±†ãƒ»ZIPSãƒ»ã‚°ãƒƒã‚ºï½œå¹´åˆ¥ æœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼ˆ5ã¤ï¼‰</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- âœ… æŠ˜ã‚Œç·šã«æ•°å€¤ãƒ©ãƒ™ãƒ«è¡¨ç¤º -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    *{ box-sizing:border-box; }
    :root{
      --bg1:#2b1b12; --bg2:#1f120c;
      --card:#fff8ef; --card2:#fff3e1;
      --text:#2a1a12; --muted:#6e574b;
      --line:rgba(42,26,18,.14);
      --shadow:0 16px 34px rgba(0,0,0,.28);
      --accent:#7a1f2b; --accent2:#5f1620;
      --danger:#b23a3a;
      --radius:16px;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background: radial-gradient(1200px 500px at 10% -10%, rgba(255,255,255,.07), transparent 60%),
                  linear-gradient(160deg,var(--bg1),var(--bg2));
      color:#fff;
    }
    header{
      position:sticky; top:0; z-index:20;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25));
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .header-inner{
      max-width:1200px; margin:0 auto;
      padding:12px 14px;
      display:flex; gap:12px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
    }
    .brand{ display:flex; gap:10px; align-items:baseline; font-weight:900; }
    .brand small{ opacity:.75; font-weight:700; }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼å³ã®æ“ä½œï¼ˆçœç•¥å¯¾å¿œï¼‰ ===== */
    .dock{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
      min-width:min(680px, 100%);
    }
    .dock-row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .dock-label{
      font-size:12px;
      opacity:.9;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
    }
    .dock-year{
      width:120px;
      text-align:right;
    }
    .dock-body{ display:block; }
    body.controls-collapsed .dock-body{ display:none; }

    .dock-grid{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
    }

    .pill{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:8px 10px;
      display:flex; gap:8px; align-items:center;
    }
    .pill label{ font-size:12px; opacity:.9; }

    input[type="text"], input[type="number"]{
      font: inherit;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color:#fff;
      padding:8px 10px;
      outline:none;
    }
    input[type="number"]{ width:90px; text-align:right; }

    button{
      font: inherit;
      cursor:pointer;
      border:0;
      border-radius:12px;
      padding:10px 12px;
      color:#fff;
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      white-space:nowrap;
    }
    button.secondary{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
    }
    button.danger{ background: rgba(178,58,58,.88); }

    main{ max-width:1200px; margin:0 auto; padding:14px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:12px; }

    .card{
      background: linear-gradient(180deg,var(--card),var(--card2));
      color:var(--text);
      border:1px solid rgba(255,255,255,.28);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:12px 14px;
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .card-title{ font-weight:900; letter-spacing:.02em; }
    .card-sub{ font-size:12px; color:var(--muted); }
    .card-body{ padding:12px 14px; }

    .row-tools{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:0 0 10px;
    }

    .table-wrap{
      overflow:auto;
      border:1px solid rgba(42,26,18,.12);
      border-radius:12px;
      background:#fff;
    }
    table{
      width:max-content; min-width:100%;
      border-collapse:separate;
      border-spacing:0;
      color:var(--text);
      font-size:13px;
    }
    th, td{
      border-bottom:1px solid rgba(42,26,18,.10);
      border-right:1px solid rgba(42,26,18,.08);
      padding:8px 8px;
      white-space:nowrap;
    }
    th:first-child, td:first-child{
      position:sticky; left:0; background:#fff; z-index:2;
      min-width:220px;
    }
    thead th{
      position:sticky; top:0; z-index:3;
      background:#fff;
      font-size:12px; color:var(--muted);
    }
    thead th:first-child{ z-index:4; }

    .name-cell{ display:flex; align-items:center; gap:8px; }
    .name-chip{
      width:10px; height:10px; border-radius:999px;
      border:1px solid rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .name-text{ font-weight:800; }
    .name-input{
      width: 100%;
      border:1px solid rgba(42,26,18,.18) !important;
      background:#fff !important;
      color:var(--text) !important;
      padding:7px 8px !important;
      border-radius:10px !important;
      outline:none !important;
    }
    .num-input{
      width:86px;
      border:1px solid rgba(42,26,18,.18) !important;
      background:#fff !important;
      color:var(--text) !important;
      padding:7px 8px !important;
      border-radius:10px !important;
      outline:none !important;
      text-align:right;
    }
    .icon-btn{
      border:1px solid rgba(42,26,18,.18);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      font-weight:800;
    }
    .icon-btn.danger{
      border-color: rgba(178,58,58,.35);
      color:#8b1d1d;
    }

    .charts{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .charts{ grid-template-columns: 1fr 1fr; }
    }
    .chart-box{
      background:#fff;
      border:1px solid rgba(42,26,18,.12);
      border-radius:14px;
      padding:10px;
      min-height:270px;
    }

    /* PDF area (portrait A4) */
    .pdf-pages{
      display:none;
      width: 700px;
      background:#fff;
      color:#111;
      padding:28px;
    }
    .pdf-title{
      font-weight:900;
      font-size:16px;
      margin:0 0 8px;
    }
    .pdf-sub{
      font-size:11px;
      color:#333;
      margin:0 0 10px;
    }
    .pdf-col{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .pdf-card{
      border:1px solid rgba(0,0,0,.12);
      border-radius:12px;
      padding:12px;
      min-height:230px;
    }
    .pdf-card canvas{ width:100% !important; height:180px !important; }
    .pdf-card.tall{ min-height:320px; }
    .pdf-card.tall canvas{ height:240px !important; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.70);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(92vw, 820px);
      white-space:nowrap;
      overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show{ opacity:1; }
    .footer-note{
      opacity:.85;
      font-size:12px;
      margin:12px 2px 0;
    }

    /* âœ… æœˆæ¬¡æ£’ã‚°ãƒ©ãƒ•ï¼ˆ5ã¤ï¼‰å³ã®Wi-Fiãƒœã‚¿ãƒ³ */
    .mini-toggle{
      width:auto;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:none;
      color:var(--text);
      font-weight:900;
    }
    .mini-toggle:active{ transform: translateY(1px); }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="brand">
      è±†ãƒ»ZIPSãƒ»ã‚°ãƒƒã‚º <small>å¹´åˆ¥ æœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼ˆ5ã¤ï¼‰</small>
    </div>

    <!-- âœ… ãƒ˜ãƒƒãƒ€ãƒ¼å³ï¼šå¹´å…¥åŠ› + ï¼ˆä¿å­˜ã€œï¼‹ã‚°ãƒƒã‚ºã‚’æŠ˜ã‚ŠãŸãŸã¿å¯ï¼‰ -->
    <div class="dock" aria-label="æ“ä½œ">
      <div class="dock-row">
        <span class="dock-label">å¹´</span>
        <input id="yearInput" class="dock-year" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š2025" min="2000" max="2100" />
        <button id="btnLoadYear" class="secondary" style="width:auto;">ã“ã®å¹´ã‚’é–‹ã</button>
      </div>

      <div id="dockBody" class="dock-body">
        <div class="dock-grid">
          <button id="btnSave">ä¿å­˜</button>
          <button id="btnRender" class="secondary">ã‚°ãƒ©ãƒ•æ›´æ–°</button>
          <button id="btnClearYear" class="danger">ã“ã®å¹´ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="btnPdf" class="secondary">PDFå‡ºåŠ›ï¼ˆA4ç¸¦/2ãƒšãƒ¼ã‚¸ï¼‰</button>
        </div>
        <div class="dock-grid">
          <button id="quickAddBeansSeasonal" class="secondary">ï¼‹è±†ã‚·ãƒ¼ã‚ºãƒŠãƒ«</button>
          <button id="quickAddZ8Seasonal" class="secondary">ï¼‹Z8ã‚·ãƒ¼ã‚ºãƒŠãƒ«</button>
          <button id="quickAddZ1Seasonal" class="secondary">ï¼‹Z1ã‚·ãƒ¼ã‚ºãƒŠãƒ«</button>
          <button id="quickAddGoods" class="secondary">ï¼‹ã‚°ãƒƒã‚º</button>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">æœˆæ¬¡æ£’ã‚°ãƒ©ãƒ•ï¼ˆ5ã¤ï¼‰</div>
          <div class="card-sub">
            â‘ è±†200gï¼‹ZIPSåˆè¨ˆï¼ˆ200g / ZIPS8P / ZIPS1Pï¼‰ï¼‹ å£²ä¸Šï¼ˆå³è»¸ï¼šä¸‡ãƒ»å°æ•°1æ¡ï¼‰ï¼‹æœˆã”ã¨æ•°å€¤è¡¨ç¤ºï½œ
            â‘¡è±†200gï¼ˆå•†å“åˆ¥ã€æŒ‡å®šè‰²å›ºå®šã€‚ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯åˆè¨ˆ1æ ï¼‰ï½œ
            â‘¢ZIPSï¼ˆ8Pï¼‰ï¼ˆå•†å“åˆ¥ã€æŒ‡å®šè‰²å›ºå®šã€‚ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯åˆè¨ˆ1æ ï¼‰ï½œ
            â‘£ZIPSï¼ˆ1Pï¼‰ï¼ˆå•†å“åˆ¥ã€æŒ‡å®šè‰²å›ºå®šã€‚ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯åˆè¨ˆ1æ ï¼‰ï½œ
            â‘¤ã‚°ãƒƒã‚ºï¼ˆåç§°åˆ¥ï¼šãƒãƒ‹ãƒ¼å›ºå®šï¼‹ä»–ã¯è–„ããªã‚‹ã‚°ãƒ¬ãƒ¼ï¼‰
          </div>
        </div>

        <!-- âœ… çœç•¥/å±•é–‹ãƒœã‚¿ãƒ³ï¼ˆã“ã“ãŒâ€œæœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼ˆ5ã¤ï¼‰â€ã®å³ï¼‰ -->
        <button id="btnControlsToggle" class="mini-toggle" type="button" aria-expanded="true" title="æ“ä½œãƒœã‚¿ãƒ³ã‚’çœç•¥/è¡¨ç¤º">
          ğŸ“¶ æ“ä½œ
        </button>
      </div>

      <div class="card-body">
        <div class="charts">
          <div class="chart-box"><canvas id="chartCombo"></canvas></div>
          <div class="chart-box"><canvas id="chartBeans200"></canvas></div>
          <div class="chart-box"><canvas id="chartZips8"></canvas></div>
          <div class="chart-box"><canvas id="chartZips1"></canvas></div>
          <div class="chart-box"><canvas id="chartGoods"></canvas></div>
        </div>
      </div>
    </div>

    <!-- å£²ä¸Šå…¥åŠ›ï¼ˆåƒå††ï¼‰ -->
    <section class="card" id="sec-sales">
      <div class="card-head">
        <div>
          <div class="card-title">å£²ä¸Šï¼ˆåƒå††ï¼‰</div>
          <div class="card-sub">â‘ ã®æŠ˜ã‚Œç·šï¼šè¡¨ç¤ºã¯ã€Œä¸‡ï¼ˆå°æ•°1æ¡ï¼‰ã€ã«ãªã‚‹ï¼ˆä¾‹ï¼š123 â†’ 12.3ä¸‡ï¼‰</div>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrapSales"></div>
      </div>
    </section>

    <section class="card" id="sec-beans200">
      <div class="card-head">
        <div>
          <div class="card-title">è±† 200gï¼ˆå›ºå®šï¼‹ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¤‡æ•°ï¼‰</div>
          <div class="card-sub">ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯ä½•å€‹ã§ã‚‚è¿½åŠ OKï¼ˆã‚°ãƒ©ãƒ•ã§ã¯ã€Œã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆã€1æ ï¼‰</div>
        </div>
        <div class="row-tools">
          <button class="secondary" id="addSeasonalBeans200">ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¿½åŠ </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrapBeans200"></div>
      </div>
    </section>

    <section class="card" id="sec-zips8">
      <div class="card-head">
        <div>
          <div class="card-title">ZIPSï¼ˆ8Pï¼‰ï¼ˆå›ºå®šï¼‹ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¤‡æ•°ï¼‰</div>
          <div class="card-sub">ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯ä½•å€‹ã§ã‚‚è¿½åŠ OKï¼ˆã‚°ãƒ©ãƒ•ã§ã¯ã€Œã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆã€1æ ï¼‰</div>
        </div>
        <div class="row-tools">
          <button class="secondary" id="addSeasonalZips8">ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¿½åŠ </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrapZips8"></div>
      </div>
    </section>

    <section class="card" id="sec-zips1">
      <div class="card-head">
        <div>
          <div class="card-title">ZIPSï¼ˆ1Pï¼‰ï¼ˆå›ºå®šï¼‹ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¤‡æ•°ï¼‰</div>
          <div class="card-sub">ã‚·ãƒ¼ã‚ºãƒŠãƒ«ã¯ä½•å€‹ã§ã‚‚è¿½åŠ OKï¼ˆã‚°ãƒ©ãƒ•ã§ã¯ã€Œã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆã€1æ ï¼‰</div>
        </div>
        <div class="row-tools">
          <button class="secondary" id="addSeasonalZips1">ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¿½åŠ </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrapZips1"></div>
      </div>
    </section>

    <section class="card" id="sec-goods">
      <div class="card-head">
        <div>
          <div class="card-title">ã‚°ãƒƒã‚ºï¼ˆåç§°è‡ªç”±è¿½åŠ ï¼‰</div>
          <div class="card-sub">ãƒãƒ‹ãƒ¼ã¯å‰Šé™¤ä¸å¯ã€‚ä»–ã¯è¿½åŠ ãƒ»å‰Šé™¤OKã€‚è‰²ã¯ãƒãƒ‹ãƒ¼å›ºå®šï¼‹ä»–ã‚°ãƒ¬ãƒ¼è–„ãã€‚</div>
        </div>
        <div class="row-tools">
          <button class="secondary" id="addGoodsItem">è¿½åŠ </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap" id="tableWrapGoods"></div>
      </div>
    </section>

    <div class="footer-note">
      ä¿å­˜å…ˆï¼šã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã® localStorageï¼ˆç«¯æœ«ã”ã¨ï¼‰ã€‚PDFã¯A4ç¸¦ãƒ»ä½™ç™½ã‚ã‚Šã§2ãƒšãƒ¼ã‚¸ã€‚
    </div>
  </div>

  <!-- PDF hidden pages -->
  <div id="pdfRoot" class="pdf-pages">
    <div class="pdf-page" id="pdfPage1">
      <p class="pdf-title">å£²ä¸Š æœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼ˆ1/2ï¼‰</p>
      <p class="pdf-sub" id="pdfSub1"></p>
      <div class="pdf-col">
        <div class="pdf-card tall"><canvas id="pdfChartCombo"></canvas></div>
        <div class="pdf-card tall"><canvas id="pdfChartBeans200"></canvas></div>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="pdf-page" id="pdfPage2">
      <p class="pdf-title">å£²ä¸Š æœˆæ¬¡ã‚°ãƒ©ãƒ•ï¼ˆ2/2ï¼‰</p>
      <p class="pdf-sub" id="pdfSub2"></p>
      <div class="pdf-col">
        <div class="pdf-card"><canvas id="pdfChartZips8"></canvas></div>
        <div class="pdf-card"><canvas id="pdfChartZips1"></canvas></div>
        <div class="pdf-card"><canvas id="pdfChartGoods"></canvas></div>
      </div>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/** åŸºæœ¬ */
const MONTHS = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
const STORAGE_KEY = "tullys-beans-sales-v5";

/** å›ºå®šå•†å“ */
const FIXED = {
  beans200: [
    "ãƒã‚¦ã‚¹ãƒ–ãƒ¬ãƒ³ãƒ‰",
    "ãƒ”ãƒƒã‚³ãƒ­ãƒãƒ³ãƒ“ãƒ¼ãƒ",
    "ãƒ–ãƒ©ã‚¸ãƒ«ãƒ•ã‚¡ã‚¼ãƒ³ãƒ€ãƒã‚¦",
    "ã‚³ã‚¹ã‚¿ãƒªã‚«",
    "ãƒ¢ã‚«ã‚¸ãƒ£ãƒ",
    "ãƒ–ãƒ©ãƒƒã‚¯ã‚¹ãƒªãƒ¼",
    "ã‚«ãƒ•ã‚§ã‚ªãƒ¬ãƒ¢ãƒŠãƒ¼ãƒ¬",
    "ã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ã‚¯ãƒ©ã‚·ã‚³",
    "ãƒ•ãƒ¬ãƒ³ãƒãƒ­ãƒ¼ã‚¹ãƒˆ",
    "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­ã€€ã‚¹ã‚¤ãƒ¼ãƒˆ",
    "ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ã€€ãƒ‡ã‚«ãƒ•ã‚§",
  ],
  zips8: [
    "ãƒã‚¦ã‚¹ãƒ–ãƒ¬ãƒ³ãƒ‰",
    "ãƒ–ãƒ©ã‚¸ãƒ«ãƒ•ã‚¡ã‚¼ãƒ³ãƒ€ãƒã‚¦",
    "ã‚³ã‚¹ã‚¿ãƒªã‚«",
    "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­ã€€ã‚¹ã‚¤ãƒ¼ãƒˆ",
    "ãƒ‡ã‚«ãƒ•ã‚§ã€€ãƒ–ãƒ©ã‚¸ãƒ«IPè¾²åœ’",
  ],
  zips1: [
    "ãƒã‚¦ã‚¹ãƒ–ãƒ¬ãƒ³ãƒ‰",
    "ãƒ–ãƒ©ã‚¸ãƒ«ãƒ•ã‚¡ã‚¼ãƒ³ãƒ€ãƒã‚¦",
    "ã‚³ã‚¹ã‚¿ãƒªã‚«",
    "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­ã€€ã‚¹ã‚¤ãƒ¼ãƒˆ",
    "ãƒ‡ã‚«ãƒ•ã‚§ã€€ãƒ–ãƒ©ã‚¸ãƒ«IPè¾²åœ’",
  ],
  goodsDefault: ["ãƒãƒ‹ãƒ¼"]
};

/** å›ºå®šã‚«ãƒ©ãƒ¼ï¼ˆåŒåã¯å…¨ã‚°ãƒ©ãƒ•åŒè‰²ï¼‰ */
const COLOR_FIXED = {
  "ãƒã‚¦ã‚¹ãƒ–ãƒ¬ãƒ³ãƒ‰": "#0f5132",
  "ãƒ”ãƒƒã‚³ãƒ­ãƒãƒ³ãƒ“ãƒ¼ãƒ": "#7fbf7f",

  "ãƒ–ãƒ©ã‚¸ãƒ«ãƒ•ã‚¡ã‚¼ãƒ³ãƒ€ãƒã‚¦": "#ffff00",
  "ã‚³ã‚¹ã‚¿ãƒªã‚«": "#f39c12",
  "ãƒ¢ã‚«ã‚¸ãƒ£ãƒ": "#c9a24d",
  "ãƒ–ãƒ©ãƒƒã‚¯ã‚¹ãƒªãƒ¼": "#0f0f0f",
  "ã‚«ãƒ•ã‚§ã‚ªãƒ¬ãƒ¢ãƒŠãƒ¼ãƒ¬": "#e6d3b1",
  "ã‚¨ã‚¹ãƒ—ãƒ¬ãƒƒã‚½ã‚¯ãƒ©ã‚·ã‚³": "#3b2416",

  "ãƒ•ãƒ¬ãƒ³ãƒãƒ­ãƒ¼ã‚¹ãƒˆ": "#c71585",
  "ã‚­ãƒªãƒãƒ³ã‚¸ãƒ£ãƒ­ã€€ã‚¹ã‚¤ãƒ¼ãƒˆ": "#0000ff",
  "ã‚ªãƒ¼ã‚¬ãƒ‹ãƒƒã‚¯ã€€ãƒ‡ã‚«ãƒ•ã‚§": "#e6e6fa",

  "ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ": "#bfa24a",
  "ãƒ‡ã‚«ãƒ•ã‚§ã€€ãƒ–ãƒ©ã‚¸ãƒ«IPè¾²åœ’": "#fffacd",

  "__COMBO__200g": "#0f766e",
  "__COMBO__Z8": "#b8a99a",
  "__COMBO__Z1": "#d08c7a",

  "ãƒãƒ‹ãƒ¼": "#f4c430",
};

let db = loadDB();

/** UI refs */
const toastEl = document.getElementById("toast");
const yearInput = document.getElementById("yearInput");
const btnLoadYear = document.getElementById("btnLoadYear");
const btnSave = document.getElementById("btnSave");
const btnRender = document.getElementById("btnRender");
const btnClearYear = document.getElementById("btnClearYear");
const btnPdf = document.getElementById("btnPdf");

const quickAdd = {
  beans: document.getElementById("quickAddBeansSeasonal"),
  z8: document.getElementById("quickAddZ8Seasonal"),
  z1: document.getElementById("quickAddZ1Seasonal"),
  goods: document.getElementById("quickAddGoods"),
};

const addSeasonalButtons = {
  beans200: document.getElementById("addSeasonalBeans200"),
  zips8: document.getElementById("addSeasonalZips8"),
  zips1: document.getElementById("addSeasonalZips1"),
};
const addGoodsItemBtn = document.getElementById("addGoodsItem");

const tableWraps = {
  sales: document.getElementById("tableWrapSales"),
  beans200: document.getElementById("tableWrapBeans200"),
  zips8: document.getElementById("tableWrapZips8"),
  zips1: document.getElementById("tableWrapZips1"),
  goods: document.getElementById("tableWrapGoods"),
};

let charts = { combo:null, beans200:null, zips8:null, zips1:null, goods:null };
let pdfCharts = { combo:null, beans200:null, zips8:null, zips1:null, goods:null };

/** âœ… æ“ä½œãƒœã‚¿ãƒ³ã®æŠ˜ã‚ŠãŸãŸã¿ï¼ˆä¿å­˜ã€œï¼‹ã‚°ãƒƒã‚ºï¼‰ */
const UI_KEY = "tullys-controls-collapsed-v1";
const btnControlsToggle = document.getElementById("btnControlsToggle");

function setControlsCollapsed(isCollapsed){
  document.body.classList.toggle("controls-collapsed", !!isCollapsed);
  if(btnControlsToggle){
    btnControlsToggle.setAttribute("aria-expanded", String(!isCollapsed));
  }
  try{ localStorage.setItem(UI_KEY, isCollapsed ? "1" : "0"); }catch(e){}
}
function loadControlsCollapsed(){
  try{ return localStorage.getItem(UI_KEY) === "1"; }catch(e){ return false; }
}

/** start */
initDefaultYear();
setControlsCollapsed(loadControlsCollapsed());
wireEvents();
openYear(getCurrentYear());
renderAllCharts();

/** å¹´ */
function initDefaultYear(){ yearInput.value = String(new Date().getFullYear()); }
function getCurrentYear(){
  const n = Number(String(yearInput.value || "").trim());
  if(Number.isFinite(n) && n >= 2000 && n <= 2100) return String(n);
  return "";
}
function requireYear(){
  const y = getCurrentYear();
  if(!y){ toast("å¹´ã‚’æ‰‹å…¥åŠ›ã—ã¦ãªï¼ˆä¾‹ï¼š2025ï¼‰"); yearInput.focus(); return null; }
  return y;
}
function ensureYearState(year){
  if(!db.years) db.years = {};
  if(!db.years[year]){ db.years[year] = makeEmptyYearState(year); persistDB(); }
  hydrateFixed(year);
}
function makeEmptyYearState(year){
  const fixedBeans = {}; FIXED.beans200.forEach(n => fixedBeans[n] = Array(12).fill(0));
  const fixedZ8 = {}; FIXED.zips8.forEach(n => fixedZ8[n] = Array(12).fill(0));
  const fixedZ1 = {}; FIXED.zips1.forEach(n => fixedZ1[n] = Array(12).fill(0));
  return {
    year,
    salesK: Array(12).fill(0), // å£²ä¸Šï¼ˆåƒå††ï¼‰
    beans200: { fixed: fixedBeans, seasonals: [] },
    zips8: { fixed: fixedZ8, seasonals: [] },
    zips1: { fixed: fixedZ1, seasonals: [] },
    goods: { items: FIXED.goodsDefault.map(name => ({ id: uid(), name, values: Array(12).fill(0) })) }
  };
}
function hydrateFixed(year){
  const st = db.years[year];
  if(!Array.isArray(st.salesK)) st.salesK = Array(12).fill(0);

  st.beans200 = st.beans200 || { fixed:{}, seasonals:[] };
  st.beans200.fixed = st.beans200.fixed || {};
  FIXED.beans200.forEach(n => { if(!Array.isArray(st.beans200.fixed[n])) st.beans200.fixed[n] = Array(12).fill(0); });

  st.zips8 = st.zips8 || { fixed:{}, seasonals:[] };
  st.zips8.fixed = st.zips8.fixed || {};
  FIXED.zips8.forEach(n => { if(!Array.isArray(st.zips8.fixed[n])) st.zips8.fixed[n] = Array(12).fill(0); });

  st.zips1 = st.zips1 || { fixed:{}, seasonals:[] };
  st.zips1.fixed = st.zips1.fixed || {};
  FIXED.zips1.forEach(n => { if(!Array.isArray(st.zips1.fixed[n])) st.zips1.fixed[n] = Array(12).fill(0); });

  st.goods = st.goods || { items:[] };
  st.goods.items = Array.isArray(st.goods.items) ? st.goods.items : [];
  if(!st.goods.items.some(it => normalizeName(it.name) === normalizeName("ãƒãƒ‹ãƒ¼"))){
    st.goods.items.unshift({ id: uid(), name: "ãƒãƒ‹ãƒ¼", values: Array(12).fill(0) });
  }
  st.goods.items.forEach(it => {
    if(!it.id) it.id = uid();
    if(typeof it.name !== "string") it.name = "";
    if(!Array.isArray(it.values)) it.values = Array(12).fill(0);
  });

  ["beans200","zips8","zips1"].forEach(cat => {
    st[cat].seasonals = Array.isArray(st[cat].seasonals) ? st[cat].seasonals : [];
    st[cat].seasonals.forEach(s => {
      if(!s.id) s.id = uid();
      if(typeof s.name !== "string") s.name = "";
      if(!Array.isArray(s.values)) s.values = Array(12).fill(0);
    });
  });
}
function openYear(year){
  if(!year){ destroyAllCharts(); return; }
  ensureYearState(year);
  buildAllTables(year);
  loadYearToInputs(year);
  renderAllCharts();
  toast(`${year}å¹´ã‚’é–‹ã„ãŸ`);
}

/** ãƒ†ãƒ¼ãƒ–ãƒ« */
function buildAllTables(year){
  buildSalesTable(year);
  buildCategoryTable(year, "beans200");
  buildCategoryTable(year, "zips8");
  buildCategoryTable(year, "zips1");
  buildGoodsTable(year);
}

function buildSalesTable(year){
  const st = db.years[year];
  const wrap = tableWraps.sales;
  let html = `<table>
    <thead><tr><th>ï¼ˆåƒå††ï¼‰</th>${MONTHS.map(m=>`<th>${m}</th>`).join("")}</tr></thead>
    <tbody>
      <tr data-rowtype="salesK">
        <td><div class="name-cell"><span class="name-text">å£²ä¸Š</span></div></td>
        ${Array.from({length:12}).map((_,i)=>`
          <td><input class="num-input" type="number" min="0" step="1" inputmode="numeric"
            data-rowtype="salesK" data-month="${i}" value="${Number(st.salesK?.[i]||0)}" /></td>
        `).join("")}
      </tr>
    </tbody></table>`;
  wrap.innerHTML = html;

  bindNumericUX(wrap);

  wrap.querySelectorAll('input.num-input[data-rowtype="salesK"]').forEach(inp => {
    inp.addEventListener("input", () => {
      sanitizeNumInput(inp);
      saveInputsToYear(year, { silent:true });
      renderAllCharts();
    });
  });
}

function buildCategoryTable(year, cat){
  const st = db.years[year];
  const wrap = tableWraps[cat]; if(!wrap) return;

  let html = `<table><thead><tr><th>å•†å“</th>${MONTHS.map(m=>`<th>${m}</th>`).join("")}<th></th></tr></thead><tbody>`;
  FIXED[cat].forEach(name => html += rowHtmlFixed(cat, name));
  st[cat].seasonals.forEach(s => html += rowHtmlSeasonal(cat, s.id));
  html += `</tbody></table>`;
  wrap.innerHTML = html;

  bindNumericUX(wrap);
  bindTableEventsForCategory(year, cat);
}
function buildGoodsTable(year){
  const st = db.years[year];
  const wrap = tableWraps.goods; if(!wrap) return;

  const honey = st.goods.items.filter(it => normalizeName(it.name) === normalizeName("ãƒãƒ‹ãƒ¼"));
  const others = st.goods.items.filter(it => normalizeName(it.name) !== normalizeName("ãƒãƒ‹ãƒ¼"));
  const ordered = [...honey, ...others];

  let html = `<table><thead><tr><th>åç§°</th>${MONTHS.map(m=>`<th>${m}</th>`).join("")}<th></th></tr></thead><tbody>`;
  ordered.forEach(it => html += rowHtmlGoods(it.id, it.name));
  html += `</tbody></table>`;
  wrap.innerHTML = html;

  bindNumericUX(wrap);
  bindTableEventsForGoods(year);
}

function rowHtmlFixed(cat, name){
  const col = getColorForLabel(name);
  return `<tr data-rowtype="fixed" data-cat="${escAttr(cat)}" data-name="${escAttr(name)}">
    <td><div class="name-cell">
      <span class="name-chip" data-chip-key="${escAttr(cat)}::${escAttr(name)}" style="background:${col}"></span>
      <span class="name-text">${esc(name)}</span>
    </div></td>
    ${Array.from({length:12}).map((_,i)=>`
      <td><input class="num-input" type="number" min="0" step="1" inputmode="numeric"
        data-cat="${escAttr(cat)}" data-rowtype="fixed" data-key="${escAttr(name)}" data-month="${i}" value="0" /></td>
    `).join("")}
    <td></td>
  </tr>`;
}
function rowHtmlSeasonal(cat, id){
  const col = getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ");
  return `<tr data-rowtype="seasonal" data-cat="${escAttr(cat)}" data-id="${escAttr(id)}">
    <td><div class="name-cell">
      <span class="name-chip" data-chip-key="${escAttr(cat)}::seasonal::${escAttr(id)}" style="background:${col}"></span>
      <input class="name-input" type="text" placeholder="" data-cat="${escAttr(cat)}" data-rowtype="seasonal" data-id="${escAttr(id)}" value="" />
    </div></td>
    ${Array.from({length:12}).map((_,i)=>`
      <td><input class="num-input" type="number" min="0" step="1" inputmode="numeric"
        data-cat="${escAttr(cat)}" data-rowtype="seasonal" data-id="${escAttr(id)}" data-month="${i}" value="0" /></td>
    `).join("")}
    <td><button class="icon-btn danger" title="å‰Šé™¤" data-action="delete-seasonal" data-cat="${escAttr(cat)}" data-id="${escAttr(id)}">Ã—</button></td>
  </tr>`;
}
function rowHtmlGoods(id, name){
  const isHoney = normalizeName(name) === normalizeName("ãƒãƒ‹ãƒ¼");
  return `<tr data-rowtype="goods" data-id="${escAttr(id)}">
    <td><div class="name-cell">
      <span class="name-chip" data-chip-key="goods::${escAttr(id)}" style="background:#6b7280"></span>
      <input class="name-input" type="text" placeholder="" data-rowtype="goods" data-id="${escAttr(id)}" value="" />
    </div></td>
    ${Array.from({length:12}).map((_,i)=>`
      <td><input class="num-input" type="number" min="0" step="1" inputmode="numeric"
        data-rowtype="goods" data-id="${escAttr(id)}" data-month="${i}" value="0" /></td>
    `).join("")}
    <td>
      ${isHoney ? "" : `<button class="icon-btn danger" title="å‰Šé™¤" data-action="delete-goods" data-id="${escAttr(id)}">Ã—</button>`}
    </td>
  </tr>`;
}

function bindTableEventsForCategory(year, cat){
  const wrap = tableWraps[cat];
  const st = db.years[year];

  wrap.querySelectorAll('input.num-input').forEach(inp => {
    inp.addEventListener("input", () => {
      sanitizeNumInput(inp);
      saveInputsToYear(year, { silent:true });
      renderAllCharts();
    });
  });

  wrap.querySelectorAll('input.name-input[data-rowtype="seasonal"]').forEach(inp => {
    inp.addEventListener("input", () => {
      saveInputsToYear(year, { silent:true });
      renderAllCharts();
    });
  });

  wrap.querySelectorAll('button[data-action="delete-seasonal"]').forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      st[cat].seasonals = st[cat].seasonals.filter(s => s.id !== id);
      persistDB();
      buildCategoryTable(year, cat);
      loadYearToInputs(year);
      renderAllCharts();
      toast("ã‚·ãƒ¼ã‚ºãƒŠãƒ«å‰Šé™¤ã—ãŸ");
    });
  });
}
function bindTableEventsForGoods(year){
  const wrap = tableWraps.goods;
  const st = db.years[year];

  wrap.querySelectorAll('input.num-input').forEach(inp => {
    inp.addEventListener("input", () => {
      sanitizeNumInput(inp);
      saveInputsToYear(year, { silent:true });
      renderAllCharts();
    });
  });

  wrap.querySelectorAll('input.name-input[data-rowtype="goods"]').forEach(inp => {
    inp.addEventListener("input", () => {
      saveInputsToYear(year, { silent:true });
      updateAllChips(year);
      renderAllCharts();
    });
  });

  wrap.querySelectorAll('button[data-action="delete-goods"]').forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const it = st.goods.items.find(x => x.id === id);
      if(it && normalizeName(it.name) === normalizeName("ãƒãƒ‹ãƒ¼")){
        toast("ãƒãƒ‹ãƒ¼ã¯å‰Šé™¤ã§ãã‚“ä»•æ§˜ã‚„ã§");
        return;
      }
      st.goods.items = st.goods.items.filter(it => it.id !== id);
      persistDB();
      buildGoodsTable(year);
      loadYearToInputs(year);
      renderAllCharts();
      toast("ã‚°ãƒƒã‚ºå‰Šé™¤ã—ãŸ");
    });
  });
}

/** âœ… æ•°å­—å…¥åŠ›UXï¼šãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã§å…¨é¸æŠï¼ˆ0æ¶ˆã™æ‰‹é–“ã‚’æ¿€æ¸›ï¼‰ */
function bindNumericUX(root){
  root.querySelectorAll('input.num-input').forEach(inp => {
    inp.addEventListener("focus", () => {
      requestAnimationFrame(() => inp.select());
    });
  });
}

/** DB â†” UI */
function loadYearToInputs(year){
  const st = db.years[year];

  const sWrap = tableWraps.sales;
  if(sWrap){
    for(let m=0;m<12;m++){
      const inp = sWrap.querySelector(`input.num-input[data-rowtype="salesK"][data-month="${m}"]`);
      if(inp) inp.value = String(Number(st.salesK?.[m] || 0));
    }
  }

  ["beans200","zips8","zips1"].forEach(cat => {
    const wrap = tableWraps[cat];
    if(!wrap) return;

    wrap.querySelectorAll('input.num-input[data-rowtype="fixed"]').forEach(inp => {
      const name = inp.getAttribute("data-key");
      const m = Number(inp.getAttribute("data-month")||0);
      inp.value = String(Number(st[cat].fixed[name]?.[m] || 0));
    });

    st[cat].seasonals.forEach(s => {
      const nameInp = wrap.querySelector(`input.name-input[data-rowtype="seasonal"][data-id="${cssEsc(s.id)}"]`);
      if(nameInp) nameInp.value = s.name || "";
      for(let m=0;m<12;m++){
        const numInp = wrap.querySelector(`input.num-input[data-rowtype="seasonal"][data-id="${cssEsc(s.id)}"][data-month="${m}"]`);
        if(numInp) numInp.value = String(Number(s.values?.[m] || 0));
      }
    });
  });

  const gWrap = tableWraps.goods;
  if(gWrap){
    st.goods.items.forEach(it => {
      const nameInp = gWrap.querySelector(`input.name-input[data-rowtype="goods"][data-id="${cssEsc(it.id)}"]`);
      if(nameInp) nameInp.value = it.name || "";
      for(let m=0;m<12;m++){
        const numInp = gWrap.querySelector(`input.num-input[data-rowtype="goods"][data-id="${cssEsc(it.id)}"][data-month="${m}"]`);
        if(numInp) numInp.value = String(Number(it.values?.[m] || 0));
      }
    });
  }

  updateAllChips(year);
}

function saveInputsToYear(year, opts={silent:false}){
  ensureYearState(year);
  const st = db.years[year];

  const sWrap = tableWraps.sales;
  if(sWrap){
    for(let m=0;m<12;m++){
      const inp = sWrap.querySelector(`input.num-input[data-rowtype="salesK"][data-month="${m}"]`);
      if(inp) st.salesK[m] = numVal(inp.value);
    }
  }

  ["beans200","zips8","zips1"].forEach(cat => {
    const wrap = tableWraps[cat];
    if(!wrap) return;

    wrap.querySelectorAll('input.num-input[data-rowtype="fixed"]').forEach(inp => {
      const name = inp.getAttribute("data-key");
      const m = Number(inp.getAttribute("data-month")||0);
      const val = numVal(inp.value);
      if(!Array.isArray(st[cat].fixed[name])) st[cat].fixed[name] = Array(12).fill(0);
      st[cat].fixed[name][m] = val;
    });

    st[cat].seasonals.forEach(s => {
      const nameInp = wrap.querySelector(`input.name-input[data-rowtype="seasonal"][data-id="${cssEsc(s.id)}"]`);
      if(nameInp) s.name = String(nameInp.value || "");
      for(let m=0;m<12;m++){
        const numInp = wrap.querySelector(`input.num-input[data-rowtype="seasonal"][data-id="${cssEsc(s.id)}"][data-month="${m}"]`);
        if(numInp) s.values[m] = numVal(numInp.value);
      }
    });
  });

  const gWrap = tableWraps.goods;
  if(gWrap){
    st.goods.items.forEach(it => {
      const nameInp = gWrap.querySelector(`input.name-input[data-rowtype="goods"][data-id="${cssEsc(it.id)}"]`);
      if(nameInp) it.name = String(nameInp.value || "");
      for(let m=0;m<12;m++){
        const numInp = gWrap.querySelector(`input.num-input[data-rowtype="goods"][data-id="${cssEsc(it.id)}"][data-month="${m}"]`);
        if(numInp) it.values[m] = numVal(numInp.value);
      }
    });
  }

  if(!st.goods.items.some(it => normalizeName(it.name) === normalizeName("ãƒãƒ‹ãƒ¼"))){
    st.goods.items.unshift({ id: uid(), name: "ãƒãƒ‹ãƒ¼", values: Array(12).fill(0) });
  }

  persistDB();
  if(!opts.silent) toast("ä¿å­˜ã—ãŸ");
}

/** åå‰æ­£è¦åŒ– */
function normalizeName(s){
  return String(s || "")
    .replace(/\u3000/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}
function getColorForLabel(label){
  const n = normalizeName(label);
  for(const k in COLOR_FIXED){
    if(normalizeName(k) === n) return COLOR_FIXED[k];
  }
  return "#64748b";
}

/** ã‚°ãƒƒã‚ºè‰² */
function getGoodsColor(name, idxNonHoney){
  const n = normalizeName(name);
  if(n === normalizeName("ãƒãƒ‹ãƒ¼")) return COLOR_FIXED["ãƒãƒ‹ãƒ¼"];
  const base = "#6b7280";
  const t = Math.min(0.15 + idxNonHoney * 0.18, 0.85);
  return mixHex(base, "#ffffff", t);
}
function mixHex(a, b, t){
  const A = hexToRgb(a), B = hexToRgb(b);
  const r = Math.round(A.r + (B.r - A.r) * t);
  const g = Math.round(A.g + (B.g - A.g) * t);
  const bl = Math.round(A.b + (B.b - A.b) * t);
  return rgbToHex(r,g,bl);
}
function hexToRgb(hex){
  const h = String(hex).replace("#","").trim();
  const v = h.length===3 ? h.split("").map(c=>c+c).join("") : h;
  const n = parseInt(v,16);
  return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
}
function rgbToHex(r,g,b){
  return "#" + [r,g,b].map(x => x.toString(16).padStart(2,"0")).join("");
}

/** ãƒãƒƒãƒ—æ›´æ–° */
function updateAllChips(year){
  const st = db.years[year];
  if(!st) return;

  ["beans200","zips8","zips1"].forEach(cat => {
    document.querySelectorAll(`[data-chip-key^="${cat}::"]`).forEach(chip => {
      const key = chip.getAttribute("data-chip-key") || "";
      const parts = key.split("::");
      if(parts[1] === "seasonal"){
        chip.style.background = getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ");
      } else {
        const name = parts.slice(1).join("::");
        chip.style.background = getColorForLabel(name);
      }
    });
  });

  const goods = st.goods.items.slice();
  const others = goods.filter(it => normalizeName(it.name) !== normalizeName("ãƒãƒ‹ãƒ¼"));
  const orderMap = new Map();
  others.forEach((it, idx) => orderMap.set(it.id, idx));

  document.querySelectorAll(`[data-chip-key^="goods::"]`).forEach(chip => {
    const key = chip.getAttribute("data-chip-key") || "";
    const id = key.split("::")[1] || "";
    const it = st.goods.items.find(x => x.id === id);
    const nm = normalizeName(it?.name || "");
    if(nm === normalizeName("ãƒãƒ‹ãƒ¼")){
      chip.style.background = getGoodsColor("ãƒãƒ‹ãƒ¼", 0);
    } else {
      const idx = orderMap.has(id) ? orderMap.get(id) : 0;
      chip.style.background = getGoodsColor(nm, idx);
    }
  });
}

/** ã‚°ãƒ©ãƒ• */
function renderAllCharts(){
  const year = getCurrentYear() || "(å¹´æœªæŒ‡å®š)";
  const st = db.years?.[getCurrentYear()] || null;
  if(!st){ destroyAllCharts(); return; }

  const beansTotal = sumMapMonthly(st.beans200.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.beans200.seasonals)[i]);
  const z8Total = sumMapMonthly(st.zips8.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.zips8.seasonals)[i]);
  const z1Total = sumMapMonthly(st.zips1.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.zips1.seasonals)[i]);

  charts.combo = renderComboWithSales(
    "chartCombo",
    charts.combo,
    `â‘  è±†200gï¼‹ZIPS åˆè¨ˆï¼ˆ${year}å¹´ï¼‰`,
    [
      { label:"200g", data: beansTotal, color: COLOR_FIXED["__COMBO__200g"] },
      { label:"ZIPSï¼ˆ8Pï¼‰", data: z8Total, color: COLOR_FIXED["__COMBO__Z8"] },
      { label:"ZIPSï¼ˆ1Pï¼‰", data: z1Total, color: COLOR_FIXED["__COMBO__Z1"] },
    ],
    st.salesK || Array(12).fill(0),
    false
  );

  const beanDatasets = [];
  FIXED.beans200.forEach(name => beanDatasets.push({
    label:name, data: st.beans200.fixed[name] || Array(12).fill(0), color: getColorForLabel(name)
  }));
  beanDatasets.push({
    label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ",
    data: sumSeasonalsMonthly(st.beans200.seasonals),
    color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ")
  });
  charts.beans200 = renderBarMulti("chartBeans200", charts.beans200, `â‘¡ è±†200gï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, beanDatasets, { stacked:true });

  const z8Datasets = [];
  FIXED.zips8.forEach(name => z8Datasets.push({
    label:name, data: st.zips8.fixed[name] || Array(12).fill(0), color: getColorForLabel(name)
  }));
  z8Datasets.push({
    label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ",
    data: sumSeasonalsMonthly(st.zips8.seasonals),
    color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ")
  });
  charts.zips8 = renderBarMulti("chartZips8", charts.zips8, `â‘¢ ZIPSï¼ˆ8Pï¼‰ï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, z8Datasets, { stacked:true });

  const z1Datasets = [];
  FIXED.zips1.forEach(name => z1Datasets.push({
    label:name, data: st.zips1.fixed[name] || Array(12).fill(0), color: getColorForLabel(name)
  }));
  z1Datasets.push({
    label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ",
    data: sumSeasonalsMonthly(st.zips1.seasonals),
    color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ")
  });
  charts.zips1 = renderBarMulti("chartZips1", charts.zips1, `â‘£ ZIPSï¼ˆ1Pï¼‰ï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, z1Datasets, { stacked:true });

  const goodsItems = st.goods.items.slice();
  const others = goodsItems.filter(it => normalizeName(it.name) !== normalizeName("ãƒãƒ‹ãƒ¼"));
  const orderMap = new Map(); others.forEach((it, idx)=> orderMap.set(it.id, idx));
  const goodsDatasets = goodsItems.map(it => {
    const idx = (normalizeName(it.name)===normalizeName("ãƒãƒ‹ãƒ¼")) ? 0 : (orderMap.get(it.id) ?? 0);
    return {
      label: normalizeName(it.name) || "(ç„¡å)",
      data: Array.isArray(it.values) ? it.values : Array(12).fill(0),
      color: getGoodsColor(it.name, idx)
    };
  });
  charts.goods = renderBarMulti("chartGoods", charts.goods, `â‘¤ ã‚°ãƒƒã‚ºï¼ˆåç§°åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, goodsDatasets, { stacked:true });

  updateAllChips(getCurrentYear());
}

function destroyAllCharts(){
  Object.keys(charts).forEach(k => { if(charts[k]) { charts[k].destroy(); charts[k]=null; } });
}

function renderBarMulti(canvasId, chartInstance, title, datasets, opt={}){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return null;
  const ctx = canvas.getContext("2d");
  if(chartInstance) chartInstance.destroy();

  const stacked = !!opt.stacked;
  const ds = datasets.map(d => ({
    type: "bar",
    label: d.label,
    data: d.data,
    backgroundColor: d.color,
    borderColor: "rgba(0,0,0,.12)",
    borderWidth: 1
  }));

  return new Chart(ctx, {
    type: "bar",
    data: { labels: MONTHS, datasets: ds },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: {
        x: { stacked },
        y: { stacked, beginAtZero: true, ticks:{ precision:0 } }
      }
    }
  });
}

/** âœ… â‘ å°‚ç”¨ï¼šæ£’ + å£²ä¸ŠæŠ˜ã‚Œç·šï¼ˆå³è»¸ï¼‰
 *  å£²ä¸Šå…¥åŠ›ï¼šåƒå††
 *  è¡¨ç¤ºï¼šä¸‡ï¼ˆå°æ•°1æ¡ï¼‰
 */
function renderComboWithSales(canvasId, chartInstance, title, barDatasets, salesK, isPdf=false){
  const canvas = document.getElementById(canvasId);
  if(!canvas) return null;
  const ctx = canvas.getContext("2d");
  if(chartInstance) chartInstance.destroy();

  // âœ… å³è»¸ã®ä½™ç™½ã‚’å®‰å®šï¼ˆPDFã‚ºãƒ¬å¯¾ç­–ï¼‰
  const widenY2 = {
    id: "widenY2",
    beforeLayout(chart){
      const y2 = chart.scales?.y2;
      if(y2) y2.paddingRight = 12;
    }
  };

  const bars = barDatasets.map(d => ({
    type: "bar",
    label: d.label,
    data: d.data,
    backgroundColor: d.color,
    borderColor: "rgba(0,0,0,.12)",
    borderWidth: 1,
    yAxisID: "y",
  }));

  const line = {
    type: "line",
    label: "å£²ä¸Šï¼ˆä¸‡ï¼‰",
    data: Array.isArray(salesK) ? salesK : Array(12).fill(0), // åƒå††ã®ã¾ã¾æŒã¤
    borderColor: "#000000",
    backgroundColor: "rgba(0,0,0,0)",
    pointBackgroundColor: "#000000",
    pointRadius: 3,
    tension: 0.25,
    yAxisID: "y2",

    // âœ… æœˆã”ã¨ã®æ•°å­—ãƒ©ãƒ™ãƒ«ï¼ˆä¸‡ / å°æ•°1æ¡ï¼‰
    datalabels: {
      display: true,
      align: "top",
      anchor: "end",
      offset: 4,
      color: "#000",
      formatter: (v) => {
        const n = Number(v) || 0; // åƒå††
        if(n <= 0) return "";
        return `${(n / 10).toFixed(1)}ä¸‡`;
      },
      font: { weight: "700", size: 10 }
    }
  };

  return new Chart(ctx, {
    data: { labels: MONTHS, datasets: [...bars, line] },
    options: {
      responsive: !isPdf,
      maintainAspectRatio: false,
      devicePixelRatio: isPdf ? 1 : undefined,
      animation: false,
      layout: { padding: { left: 8, right: isPdf ? 28 : 10, top: 6, bottom: 6 } },
      plugins: {
        legend: { display: true },
        datalabels: { display: (ctx) => ctx.dataset.type === "line" }
      },
      scales: {
        x: { stacked:false },
        y: { stacked:false, beginAtZero:true, ticks:{ precision:0 } },
        y2: {
          position: "right",
          beginAtZero: true,
          grid: { drawOnChartArea: false },
          // âœ… å³è»¸è¡¨ç¤ºã‚‚ä¸‡ï¼ˆå°æ•°1æ¡ï¼‰
          ticks: { callback: (v) => `${(Number(v)/10).toFixed(1)}` }
        }
      }
    },
    plugins: [widenY2, ChartDataLabels]
  });
}

/** sums */
function sumMapMonthly(map){
  const out = Array(12).fill(0);
  Object.values(map || {}).forEach(arr => {
    if(!Array.isArray(arr)) return;
    for(let i=0;i<12;i++) out[i] += Number(arr[i]||0);
  });
  return out;
}
function sumSeasonalsMonthly(list){
  const out = Array(12).fill(0);
  (list||[]).forEach(s => {
    const arr = s?.values;
    if(!Array.isArray(arr)) return;
    for(let i=0;i<12;i++) out[i] += Number(arr[i]||0);
  });
  return out;
}

/** PDF */
async function exportPdf2Pages(){
  const year = requireYear();
  if(!year) return;

  saveInputsToYear(year, { silent:true });
  renderAllCharts();

  const subtitle = `å¯¾è±¡å¹´ï¼š${year}å¹´ã€€/ã€€ä½œæˆæ—¥ï¼š${new Date().toLocaleString("ja-JP")}`;
  document.getElementById("pdfSub1").textContent = subtitle;
  document.getElementById("pdfSub2").textContent = subtitle;

  const pdfRoot = document.getElementById("pdfRoot");
  pdfRoot.style.display = "block";

  const st = db.years[year];

  const beansTotal = sumMapMonthly(st.beans200.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.beans200.seasonals)[i]);
  const z8Total = sumMapMonthly(st.zips8.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.zips8.seasonals)[i]);
  const z1Total = sumMapMonthly(st.zips1.fixed).map((v,i)=> v + sumSeasonalsMonthly(st.zips1.seasonals)[i]);

  pdfCharts.combo = renderComboWithSales(
    "pdfChartCombo",
    pdfCharts.combo,
    `â‘  è±†200gï¼‹ZIPS åˆè¨ˆï¼ˆ${year}å¹´ï¼‰`,
    [
      { label:"200g", data: beansTotal, color: COLOR_FIXED["__COMBO__200g"] },
      { label:"ZIPSï¼ˆ8Pï¼‰", data: z8Total, color: COLOR_FIXED["__COMBO__Z8"] },
      { label:"ZIPSï¼ˆ1Pï¼‰", data: z1Total, color: COLOR_FIXED["__COMBO__Z1"] },
    ],
    st.salesK || Array(12).fill(0),
    true
  );

  const beanDatasets = [];
  FIXED.beans200.forEach(name => beanDatasets.push({ label:name, data: st.beans200.fixed[name]||Array(12).fill(0), color: getColorForLabel(name) }));
  beanDatasets.push({ label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ", data: sumSeasonalsMonthly(st.beans200.seasonals), color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ") });
  pdfCharts.beans200 = renderBarMulti("pdfChartBeans200", pdfCharts.beans200, `â‘¡ è±†200gï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, beanDatasets, { stacked:true });

  const z8Datasets = [];
  FIXED.zips8.forEach(name => z8Datasets.push({ label:name, data: st.zips8.fixed[name]||Array(12).fill(0), color: getColorForLabel(name) }));
  z8Datasets.push({ label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ", data: sumSeasonalsMonthly(st.zips8.seasonals), color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ") });
  pdfCharts.zips8 = renderBarMulti("pdfChartZips8", pdfCharts.zips8, `â‘¢ ZIPSï¼ˆ8Pï¼‰ï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, z8Datasets, { stacked:true });

  const z1Datasets = [];
  FIXED.zips1.forEach(name => z1Datasets.push({ label:name, data: st.zips1.fixed[name]||Array(12).fill(0), color: getColorForLabel(name) }));
  z1Datasets.push({ label:"ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ", data: sumSeasonalsMonthly(st.zips1.seasonals), color: getColorForLabel("ã‚·ãƒ¼ã‚ºãƒŠãƒ«åˆè¨ˆ") });
  pdfCharts.zips1 = renderBarMulti("pdfChartZips1", pdfCharts.zips1, `â‘£ ZIPSï¼ˆ1Pï¼‰ï¼ˆå•†å“åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, z1Datasets, { stacked:true });

  const goodsItems = st.goods.items.slice();
  const others = goodsItems.filter(it => normalizeName(it.name) !== normalizeName("ãƒãƒ‹ãƒ¼"));
  const orderMap = new Map(); others.forEach((it, idx)=> orderMap.set(it.id, idx));
  const goodsDatasets = goodsItems.map(it => {
    const idx = (normalizeName(it.name)===normalizeName("ãƒãƒ‹ãƒ¼")) ? 0 : (orderMap.get(it.id) ?? 0);
    return { label: normalizeName(it.name)||"(ç„¡å)", data:Array.isArray(it.values)?it.values:Array(12).fill(0), color:getGoodsColor(it.name, idx) };
  });
  pdfCharts.goods = renderBarMulti("pdfChartGoods", pdfCharts.goods, `â‘¤ ã‚°ãƒƒã‚ºï¼ˆåç§°åˆ¥ï¼‰ï¼ˆ${year}å¹´ï¼‰`, goodsDatasets, { stacked:true });

  await wait(220);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });
  const M = 24;

  const p1 = document.getElementById("pdfPage1");
  const c1 = await html2canvas(p1, { scale: 2, backgroundColor: "#ffffff" });
  addCanvasToPdf(doc, c1, M);

  doc.addPage();
  const p2 = document.getElementById("pdfPage2");
  const c2 = await html2canvas(p2, { scale: 2, backgroundColor: "#ffffff" });
  addCanvasToPdf(doc, c2, M);

  doc.save(`å£²ä¸Šã‚°ãƒ©ãƒ•_${year}.pdf`);
  pdfRoot.style.display = "none";
  toast("PDFå‡ºåŠ›ã—ãŸï¼ˆA4ç¸¦/2ãƒšãƒ¼ã‚¸/ä½™ç™½ã‚ã‚Šï¼‰");
}
function addCanvasToPdf(doc, canvas, margin){
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const imgData = canvas.toDataURL("image/png");

  const maxW = pageW - margin*2;
  const maxH = pageH - margin*2;

  const imgW = maxW;
  const imgH = (canvas.height * imgW) / canvas.width;

  if(imgH <= maxH){
    const y = margin + (maxH - imgH) / 2;
    doc.addImage(imgData, "PNG", margin, y, imgW, imgH);
  } else {
    const scale = maxH / imgH;
    const w = imgW * scale;
    const x = margin + (maxW - w) / 2;
    doc.addImage(imgData, "PNG", x, margin, w, maxH);
  }
}
function wait(ms){ return new Promise(r => setTimeout(r, ms)); }

/** è¿½åŠ  */
function addSeasonal(year, cat){
  ensureYearState(year);
  db.years[year][cat].seasonals.push({ id: uid(), name: "", values: Array(12).fill(0) });
  persistDB();
  buildCategoryTable(year, cat);
  loadYearToInputs(year);
  renderAllCharts();
  toast("ã‚·ãƒ¼ã‚ºãƒŠãƒ«è¿½åŠ ã—ãŸ");
}
function addGoodsItem(year){
  ensureYearState(year);
  db.years[year].goods.items.push({ id: uid(), name: "", values: Array(12).fill(0) });
  persistDB();
  buildGoodsTable(year);
  loadYearToInputs(year);
  renderAllCharts();
  toast("ã‚°ãƒƒã‚ºè¿½åŠ ã—ãŸ");
}

/** ã‚¤ãƒ™ãƒ³ãƒˆ */
function wireEvents(){
  // âœ… ğŸ“¶ æ“ä½œãƒˆã‚°ãƒ«
  if(btnControlsToggle){
    btnControlsToggle.addEventListener("click", () => {
      const now = document.body.classList.contains("controls-collapsed");
      setControlsCollapsed(!now);
      toast(!now ? "æ“ä½œãƒœã‚¿ãƒ³ã‚’çœç•¥ã—ãŸ" : "æ“ä½œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãŸ");
    });
  }

  btnLoadYear.addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    openYear(y);
  });

  btnSave.addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    saveInputsToYear(y, { silent:false });
    updateAllChips(y);
  });

  btnRender.addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    saveInputsToYear(y, { silent:true });
    updateAllChips(y);
    renderAllCharts();
    toast("ã‚°ãƒ©ãƒ•æ›´æ–°ã—ãŸ");
  });

  btnClearYear.addEventListener("click", () => {
    const y = requireYear(); if(!y) return;
    if(!confirm(`${y}å¹´ã®å…¥åŠ›ã‚’å…¨éƒ¨ã‚¼ãƒ­ã«æˆ»ã™ã§ã€‚ã»ã‚“ã¾ã«ï¼Ÿ`)) return;
    db.years[y] = makeEmptyYearState(y);
    persistDB();
    openYear(y);
    toast(`${y}å¹´ã‚’ãƒªã‚»ãƒƒãƒˆã—ãŸ`);
  });

  btnPdf.addEventListener("click", exportPdf2Pages);

  addSeasonalButtons.beans200.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"beans200"); });
  addSeasonalButtons.zips8.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"zips8"); });
  addSeasonalButtons.zips1.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"zips1"); });
  addGoodsItemBtn.addEventListener("click", () => { const y=requireYear(); if(y) addGoodsItem(y); });

  quickAdd.beans.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"beans200"); });
  quickAdd.z8.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"zips8"); });
  quickAdd.z1.addEventListener("click", () => { const y=requireYear(); if(y) addSeasonal(y,"zips1"); });
  quickAdd.goods.addEventListener("click", () => { const y=requireYear(); if(y) addGoodsItem(y); });
}

/** æ°¸ç¶šåŒ– */
function loadDB(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { years:{} };
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return { years:{} };
    if(!parsed.years) parsed.years = {};
    return parsed;
  }catch(e){
    console.warn("loadDB failed", e);
    return { years:{} };
  }
}
function persistDB(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  catch(e){ console.warn("persistDB failed", e); }
}

/** å°ç‰© */
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1300);
}
function uid(){ return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
function sanitizeNumInput(inp){
  if(inp.value === "") return;
  const n = Number(inp.value);
  if(!Number.isFinite(n) || n < 0) inp.value = "0";
}
function numVal(v){
  const s = String(v||"").trim();
  if(s==="") return 0;
  const n = Number(s);
  if(!Number.isFinite(n) || n<0) return 0;
  return Math.round(n);
}
function esc(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[m]));
}
function escAttr(s){ return String(s).replace(/"/g, "&quot;"); }
function cssEsc(s){ return String(s).replace(/(["\\#.:\\[\\]\\s])/g, "\\$1"); }
</script>
</body>
</html>
